// Generated by LiveScript 1.2.0
(function(){
  define(['repository', 'template!./items', 'template!./item', 'jquery', 'underscore', 'uuid'], function(repo, temp, itemp, $, _, uuid){
    return {
      view: function(){
        var addItem, addComment;
        $('.items').append($(temp()));
        _(repo.items()).chain().sortBy(function(it){
          return -new Date(it.date);
        }).each(function(it){
          return $('.items-list').append($(itemp((it.author = repo.friend(it.author), it))));
        });
        addItem = function(){
          var item;
          item = {
            text: $('.text-send').val(),
            id: new uuid().toString(),
            author: repo.me().id,
            date: new Date(),
            version: 1
          };
          repo.postItem(item);
          return $('.items-list').prepend($(itemp((item.author = repo.friend(item.author), item))));
        };
        addComment = function(refId, text){
          var item;
          item = {
            text: text,
            id: new uuid().toString(),
            author: repo.me().id,
            date: new Date(),
            version: 1,
            ref: refId
          };
          return repo.postItem(item);
        };
        $('.text-send').val('');
        $('.btn-send').click(function(){
          return addItem();
        });
        $('.text-send').keydown(function(it){
          if (it.which === 13) {
            it.preventDefault();
            return addItem();
          }
        });
        $('.text-comment').keydown(function(it){
          var tf, text, refId;
          if (it.which === 13) {
            it.preventDefault();
            tf = $(this);
            text = tf.val();
            refId = tf.closest('.list-group-item').data('id');
            return addComment(refId, text);
          }
        });
        return $('.comment-button').click(function(){
          return $(this).closest('.list-group-item').find('.comment-text').toggleClass('hide');
        });
      }
    };
  });
}).call(this);
